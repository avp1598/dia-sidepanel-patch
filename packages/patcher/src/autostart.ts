import { mkdirSync, writeFileSync, rmSync, existsSync } from "node:fs";
import { join, resolve } from "node:path";
import { homedir } from "node:os";
import { execSync, spawn } from "node:child_process";

const CONFIG_DIR = join(homedir(), ".config", "arc-sidepanel-patcher");
const LAUNCHER_PATH = join(CONFIG_DIR, "launcher.sh");
const PLIST_PATH = join(homedir(), "Library", "LaunchAgents", "com.arc-sidepanel-patcher.plist");
const LOG_PATH = "/tmp/arc-sidepanel-patcher.log";
const LABEL = "com.arc-sidepanel-patcher";

function getBinaryPath(): string {
  try {
    return execSync("which arc-sidepanel-patcher", { encoding: "utf-8" }).trim();
  } catch {
    return resolve(process.argv[1]);
  }
}

function generateLauncher(binaryPath: string, port: number): string {
  return `#!/bin/bash
# Generated by arc-sidepanel-patcher install

# Source shell profile to get PATH (nvm, brew, volta, etc.)
[ -f "$HOME/.zshrc" ] && source "$HOME/.zshrc" 2>/dev/null
[ -f "$HOME/.bash_profile" ] && source "$HOME/.bash_profile" 2>/dev/null

PORT=${port}
ARC="/Applications/Arc.app/Contents/MacOS/Arc"

pkill -f "arc-sidepanel-patcher" 2>/dev/null

# If Arc is running without CDP, quit and relaunch
if pgrep -x Arc >/dev/null && ! curl -s "http://127.0.0.1:$PORT/json/version" >/dev/null 2>&1; then
  osascript -e 'tell application "Arc" to quit' 2>/dev/null
  sleep 2
fi

"$ARC" --remote-debugging-port=$PORT &

for i in $(seq 1 30); do
  curl -s "http://127.0.0.1:$PORT/json/version" >/dev/null 2>&1 && break
  sleep 0.5
done

exec "${binaryPath}" --port $PORT >> "${LOG_PATH}" 2>&1
`;
}

function generatePlist(): string {
  return `<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
    <key>Label</key>
    <string>${LABEL}</string>
    <key>ProgramArguments</key>
    <array>
        <string>/bin/bash</string>
        <string>${LAUNCHER_PATH}</string>
    </array>
    <key>RunAtLoad</key>
    <true/>
    <key>KeepAlive</key>
    <false/>
    <key>StandardOutPath</key>
    <string>${LOG_PATH}</string>
    <key>StandardErrorPath</key>
    <string>${LOG_PATH}</string>
</dict>
</plist>`;
}

export function isInstalled(): boolean {
  return existsSync(PLIST_PATH);
}

export function install(port: number = 9222): void {
  if (isInstalled()) {
    console.log("Already installed. Run 'arc-sidepanel-patcher uninstall' first.");
    return;
  }

  const binaryPath = getBinaryPath();

  mkdirSync(CONFIG_DIR, { recursive: true });
  writeFileSync(LAUNCHER_PATH, generateLauncher(binaryPath, port), { mode: 0o755 });
  console.log("  ✓ Created launcher script");

  writeFileSync(PLIST_PATH, generatePlist());
  console.log("  ✓ Created LaunchAgent (auto-starts on login)");

  // Activate now — restart Arc with CDP and start the patcher in background
  console.log("  ⟳ Starting Arc with debugging enabled...");
  const child = spawn("bash", [LAUNCHER_PATH], {
    detached: true,
    stdio: "ignore",
  });
  child.unref();

  console.log(`\n  Auto-start installed. Logs: ${LOG_PATH}`);
  console.log("  To remove: arc-sidepanel-patcher uninstall");
}

export function uninstall(): void {
  if (!isInstalled()) {
    console.log("Not installed.");
    return;
  }

  try {
    execSync(`launchctl unload "${PLIST_PATH}" 2>/dev/null`);
  } catch { /* may already be unloaded */ }

  rmSync(PLIST_PATH, { force: true });
  rmSync(CONFIG_DIR, { recursive: true, force: true });

  console.log("  ✓ Removed LaunchAgent and config");
  console.log("Auto-start uninstalled.");
}

export function status(): void {
  if (isInstalled()) {
    console.log("Installed: auto-start is active");
    console.log(`  LaunchAgent: ${PLIST_PATH}`);
    console.log(`  Launcher: ${LAUNCHER_PATH}`);
    console.log(`  Logs: ${LOG_PATH}`);
  } else {
    console.log("Not installed. Run 'arc-sidepanel-patcher install' to auto-start with Arc.");
  }
}
